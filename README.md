# Archy

Archy is an interactive Arch Linux installer script that provisions disks, installs packages, and applies dotfiles based on a declarative YAML setup. Run it from an Arch live environment to reuse the same configuration across multiple machines.

## Repository layout

- `bin/archyinstall.py` – entrypoint that guides you through selecting a setup, partitions disks, runs `pacstrap`, and installs packages inside `/mnt`.
- `bin/copypackages.py` – helper that exports the current system's explicit packages into `packages/pacman.txt` and `packages/aur.txt`.
- `lib/` – helpers for loading setups, validating models, partition planning, and package installation.
- `setups/` – per-machine configuration directories. Each setup must include a `setup.yaml` file. Package lists and shared config files can live either beside the setup directory or in the repository root for reuse across setups.
- `packages/` – saved package lists generated by `bin/copypackages`.

## Prerequisites

- Booted into an Arch live ISO with internet access.
- UEFI firmware (the script reads `/sys/firmware/efi/fw_platform_size` and configures `systemd-boot`).
- Run as root so partitioning, mounting, and `pacstrap` succeed.

## Defining a setup

Create a directory under `setups/` (for example, `setups/my-laptop`) containing:

- `setup.yaml` – describes system settings, disks, package lists, and dotfiles.
- Optional dotfiles or configuration folders to copy into the target system. Package list files and common config can also live one level above `setups/` so multiple setups can share them.

Example `setup.yaml`:

```yaml
system:
  hostname: surfacebook4
  timezone: America/New_York
  locale: en_US.UTF-8
  users:
    - username: sean
      sudo: true

storage:
  - disk: /dev/nvme0n1
    wipe: true
    partitions:
      - mount: /boot
        fs: vfat
        size: 512M
      - mount: swap
        size: 4G
      - mount: /
        fs: btrfs
        size: fill

packages:
  - pacman: ../pacman.txt
    aur: ../aur.txt

dotfiles:
  - copy_to: /home/sean/.config/
    copy_from: .config
```

Key fields:

- `system` – hostname, timezone, locale, and users. The first sudo-capable user is used for AUR builds.
- `storage` – disks and partitions. Each partition specifies a mount (`/`, `/boot`, or `swap`), filesystem (`ext4`, `btrfs`, `xfs`, `vfat`), and size (e.g., `512M`, `4G`, or `fill` for the remainder).
- `packages` – one or more groups, each pointing to optional `pacman` and `aur` package list files. Relative paths are resolved first against the setup directory, then against `setups/`, and finally against the repository root so shared lists can live alongside the `setups/` directory.
- `dotfiles` – entries that copy files or directories into the target filesystem (paths are resolved relative to the setup directory, then `setups/`, then the repository root unless absolute).

## Running the installer

1. Boot into the Arch live ISO and clone this repository.
2. From the repo root, run:

   ```bash
   ./bin/archyinstall.py
   ```

3. Choose a setup from the menu, review the partition plan, and confirm the prompts.
4. The script will partition disks, mount them under `/mnt`, run `pacstrap`, generate fstab, configure locale/timezone/hostname, create users, and install packages (including AUR packages via the sudo-enabled user).

## Exporting package lists from an installed system

Run `./bin/copypackages.py` on an Arch system to snapshot explicitly installed packages into `packages/pacman.txt` (official repos) and `packages/aur.txt` (AUR/foreign). Point to these files from your `setup.yaml` to reuse the package set in future installs.

## Safety notes

- Partitioning is destructive when `wipe: true` is set. Double-check disk identifiers before confirming.
- The script assumes UEFI boot and enables `systemd-boot` plus `NetworkManager` inside the new system.
- Keep your package lists and dotfiles under version control to repeat installations safely.
